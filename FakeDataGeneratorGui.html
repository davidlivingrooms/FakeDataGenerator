<!DOCTYPE html>
<html style="padding:20px">
<head>
  <meta charset="utf-8">
  <title>Fake Data Generator</title>

  <script type="text/javascript">
    document.write('<link rel="import" href="' + window.Alteryx.LibDir + '2/lib/includes.html">');
  </script>
</head>
<body>
    <fieldset>
      <legend class='blueTitle'>Options</legend>
      <div class='rightCon'>
        <label>Number of Records to generate</label>
          <ayx data-ui-props="{type: 'NumericSpinner', widgetId: 'numRecordsSpinner'}"></ayx>
      </div>

   </fieldset>

    <fieldset>
      <legend class='blueTitle'>Column Builder</legend>
      <div id="container" class="container">
        <div id="row" class="row">
          <label>Column Name</label>
          <ayx data-ui-props="{type: 'TextBox', widgetId: 'fieldNameTextBox', 'placeholder': 'Enter new column name here'}"></ayx>
          <label>XMSG("Provider")</label>
          <ayx data-ui-props="{type: 'DropDown', widgetId: 'providerDropDown'}"></ayx>
        </div>
      </div>
      <div class='accordion-add' onclick='Alteryx.Gui.FakeDataGenerator.addNewColumn()'></div>
    </fieldset>

  <script type="text/javascript">

     function appendAyxTagToTarget ({targetEl, uiProps}) {
      const ayxTag = document.createElement('ayx')
      ayxTag.setAttribute('data-ui-props', `${JSON.stringify(uiProps)}`)
      targetEl.appendChild(ayxTag)
    }

    window.Alteryx.Gui.FakeDataGenerator = {
      fakerProviderDataItemConfig: {
        dataName: 'FakerProvider',
        optionList: [
          {
            value: 'address',
            label: 'Address'
          },
          {
            value: 'country',
            label: 'Country'
          }
        ]
      },
      addNewColumn: function () {
        const fieldId = 'Field_' + Math.random() + Date.now()
        window.Alteryx.Gui.FakeDataGenerator.addColumn({fieldId})
      },
      addColumn: function ({providerValue, fieldNameValue, fieldId}) {
        const fieldNameId =  'fieldNameTextBox_' + Math.random() + Date.now()
        const providerId = 'providerDropDown_' + Math.random() + Date.now()

        // add container
        const row = document.createElement('div')
        row.className = 'row'

        // add textbox label
        const textBoxLabel = document.createElement('label')
        textBoxLabel.innerText = 'Column Name'
        row.appendChild(textBoxLabel)

        // add textbox
        const textBoxUIProps = {
          type: 'TextBox',
          widgetId: fieldNameId,
          placeholder: 'Enter new column name here'
        }

        appendAyxTagToTarget({
          targetEl: row,
          uiProps: textBoxUIProps
        })

        // add dropdown label
        const dropDownLabel = document.createElement('label')
        dropDownLabel.innerText = 'Generator Type'
        row.appendChild(dropDownLabel)

        // add dropdown
        const providerUIProps = {
          type: 'DropDown',
          widgetId: providerId,
        }

        appendAyxTagToTarget({
          targetEl: row,
          uiProps: providerUIProps
        })

        document.getElementById('container').appendChild(row)

        // render the row so that the widget id is available
        window.Alteryx.Gui.Manager.addWidget(row)

        const alteryxDataItems = window.Alteryx.Gui.FakeDataGenerator.AlteryxDataItems
        const manager = window.Alteryx.Gui.Manager

        // create and add data item container to parent
        const fieldContainer = new alteryxDataItems.DataItemContainer(fieldId)

        const simpleString = new alteryxDataItems.SimpleString('FieldName')
        if (fieldNameValue) {
          simpleString.setValue(fieldNameValue)
        }


        const stringSelector = new alteryxDataItems.StringSelector('Provider')
        stringSelector.setOptionList(window.Alteryx.Gui.FakeDataGenerator.fakerProviderDataItemConfig.optionList)

        if (providerValue) {
          stringSelector.setValue(providerValue)
        }

        manager.bindDataItemToWidget(simpleString, fieldNameId)
        manager.bindDataItemToWidget(stringSelector, providerId)
        fieldContainer.addDataItem(simpleString)
        fieldContainer.addDataItem(stringSelector)
        manager.getDataItem('FakeFields').addDataItem(fieldContainer)
      },
    }

    Alteryx.Gui.BeforeLoad = function (manager, AlteryxDataItems, json) {
      window.Alteryx.Gui.FakeDataGenerator.AlteryxDataItems = AlteryxDataItems
      const constrainedFloat = new AlteryxDataItems.ConstrainedFloat('NumRecords')
      manager.bindDataItemToWidget(constrainedFloat, 'numRecordsSpinner')
      manager.addDataItem(constrainedFloat)

      // create data item containers to make it easier to generate nested xml
      const fakeFieldContainer = new AlteryxDataItems.DataItemContainer('FakeFields')
      manager.addDataItem(fakeFieldContainer)

      // each field will be in its own data item container
      const fieldContainer = new AlteryxDataItems.DataItemContainer('Field')
      const simpleString = new AlteryxDataItems.SimpleString('FieldName')
      const stringSelector = new AlteryxDataItems.StringSelector('Provider')
      stringSelector.setOptionList(window.Alteryx.Gui.FakeDataGenerator.fakerProviderDataItemConfig.optionList)
      manager.bindDataItemToWidget(simpleString, 'fieldNameTextBox')
      manager.bindDataItemToWidget(stringSelector, 'providerDropDown')
      fieldContainer.addDataItem(simpleString)
      fieldContainer.addDataItem(stringSelector)

      fakeFieldContainer.addDataItem(fieldContainer)

      // parse incoming json and add new dom elements if we need to
      const configuration = json.Configuration
      if (configuration) {

        // add widgets and data items for any persisted fields
        if (Object.keys(configuration.FakeFields).length) {
          const fakeFields = configuration.FakeFields
          Object.keys(fakeFields).forEach(function (key) {
            if (key === 'Field') return // the first one is already in the html and has a data item
            const field = fakeFields[key]
            console.log(field.FieldName)
            console.log(field.Provider)

            // add widgets
            window.Alteryx.Gui.FakeDataGenerator.addColumn({
              providerValue: field.Provider,
              fieldNameValue: field.FieldName,
              fieldId: key
            })
          })
        }
      }
    }

  </script>

  <style>
    /*This styling needs to be here. Is due to file loading. Otherwise, will not get proper styling on dropdowns*/

    .Select, .Select div, .Select input, .Select span {
      box-sizing: content-box;
      -webkit-box-sizing: content-box;
    }

    .accordion-add {
      background-image: url('./img/add.png');
      background-repeat: no-repeat;
      width: 20px;
      height: 20px;
      background-color: #1691c6;
      background-size: 14px;
      background-position: 3px;
      margin-left: calc(100% - 20px);
      cursor: pointer;
      clear: both;
    }

  </style>
</body>
</html>
